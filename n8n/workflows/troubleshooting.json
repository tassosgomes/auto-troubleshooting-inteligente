{
  "name": "Recepcao de Alertas - Auto Troubleshooting",
  "nodes": [
    {
      "parameters": {
        "path": "alert",
        "httpMethod": "POST",
        "responseMode": "responseNode"
      },
      "id": "1",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [200, 300],
      "webhookId": "b2e6f1d2-4f8c-4a1b-9b0f-6c7d7b1c2a10"
    },
    {
      "parameters": {
        "language": "javascript",
        "jsCode": "const required = ['service_name', 'namespace', 'pod_name', 'error_message'];\nconst item = $input.first().json;\nconst payload = item?.body ?? item;\nconst missing = required.filter((field) => !payload?.[field]);\n\nreturn [\n  {\n    json: {\n      ...payload,\n      isValid: missing.length === 0,\n      missing,\n      errorMessage: missing.length\n        ? `Campos obrigatórios faltando: ${missing.join(', ')}`\n        : null,\n    },\n  },\n];"
      },
      "id": "2",
      "name": "Validar Payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [420, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.isValid}}",
              "value2": true
            }
          ]
        }
      },
      "id": "3",
      "name": "Payload valido?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [640, 300]
    },
    {
      "parameters": {
        "language": "javascript",
        "jsCode": "const alert = $json;\nconsole.log('[ALERT] Webhook recebido', JSON.stringify(alert));\nreturn $input.all();"
      },
      "id": "4",
      "name": "Log Alert",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [860, 240]
    },
    {
      "parameters": {
        "language": "javascript",
        "jsCode": "const alert = $json;\n\nconst systemPrompt = `# INSTRUÇÕES DO ASSISTENTE DE DIAGNÓSTICO\n\nVocê é um especialista em diagnóstico de incidentes de software. Sua tarefa é analisar alertas de erro e fornecer diagnósticos precisos e acionáveis.\n\n## FLUXO DE ANÁLISE\n\n1. **TRIAGEM**: Classifique o erro em uma das categorias:\n   - \`infrastructure\`: Problemas de Kubernetes (OOMKilled, CrashLoopBackOff, probes, recursos)\n   - \`code\`: Bugs de aplicação (exceções, null pointers, erros de lógica)\n   - \`unknown\`: Casos inconclusivos que precisam investigação adicional\n\n2. **INVESTIGAÇÃO**: Use as ferramentas disponíveis para coletar evidências:\n   - Para \`infrastructure\`: use tools de Kubernetes (describePod, getEvents, etc.)\n   - Para \`code\`: use tools de Git (cloneRepo, readFile) para analisar o código\n   - Para \`unknown\`: use httpRequest para testar conectividade se relevante\n\n3. **DIAGNÓSTICO**: Produza um relatório com:\n   - Resumo executivo (2-3 frases)\n   - Classificação e confiança\n   - Evidências coletadas\n   - Causa raiz identificada\n   - Sugestões de correção\n\n## INSTRUÇÕES DE SEGURANÇA (OBRIGATÓRIAS)\n\nNUNCA inclua no relatório:\n- Valores de variáveis de ambiente\n- Valores de Secrets do Kubernetes\n- Senhas, tokens, API keys ou credenciais\n- Dados pessoais (PII)\n\nAo mencionar Secrets ou ConfigMaps, liste APENAS os nomes das chaves, NUNCA os valores.\n\n✅ CORRETO: \"O Secret \\\"db-credentials\\\" possui as chaves: username, password, host\"\n❌ INCORRETO: \"O Secret \\\"db-credentials\\\" contém: username=admin, password=abc123\"\n\n## FORMATO DE RESPOSTA\n\nResponda sempre em JSON estruturado:\n\n{\n  \"classification\": \"infrastructure|code|unknown\",\n  \"confidence\": \"alta|média|baixa\",\n  \"reasoning\": \"Breve explicação da classificação\"\n}\n`;\n\nconst triagePrompt = `Analise o seguinte alerta de erro e classifique-o:\n\n**Serviço:** ${alert.service_name ?? ''}\n**Namespace:** ${alert.namespace ?? ''}\n**Pod:** ${alert.pod_name ?? ''}\n**Erro:** ${alert.error_message ?? ''}\n**Stack Trace:** ${alert.stack_trace ?? ''}\n\nResponda APENAS com JSON:\n{\n  \"classification\": \"infrastructure|code|unknown\",\n  \"confidence\": \"alta|média|baixa\",\n  \"reasoning\": \"Breve explicação da classificação\"\n}`;\n\nconst provider = ($env.LLM_PROVIDER || 'openai').toLowerCase();\nconst model = $env.LLM_MODEL || 'gpt-5.2';\n\nconst timeoutSeconds = Number($env.LLM_TIMEOUT_SECONDS ?? 60);\nconst timeoutMs = Number.isFinite(timeoutSeconds) && timeoutSeconds > 0\n  ? timeoutSeconds * 1000\n  : 60000;\n\nconst openAiPayload = {\n  model,\n  messages: [\n    { role: 'system', content: systemPrompt },\n    { role: 'user', content: triagePrompt },\n  ],\n  temperature: 0.2,\n};\n\nconst geminiPayload = {\n  contents: [\n    { role: 'user', parts: [{ text: triagePrompt }] },\n  ],\n  systemInstruction: { parts: [{ text: systemPrompt }] },\n  generationConfig: { temperature: 0.2, responseMimeType: 'application/json' },\n};\n\nconst requestOptions = provider === 'gemini' ? {\n  method: 'POST',\n  url: 'https://generativelanguage.googleapis.com/v1/models/gemini-3.0-pro:generateContent',\n  headers: {\n    'content-type': 'application/json',\n    'x-goog-api-key': $env.LLM_API_KEY || '',\n  },\n  body: geminiPayload,\n  json: true,\n  timeout: timeoutMs,\n} : {\n  method: 'POST',\n  url: 'https://api.openai.com/v1/chat/completions',\n  headers: {\n    'content-type': 'application/json',\n    Authorization: `Bearer ${$env.LLM_API_KEY || ''}`\n  },\n  body: openAiPayload,\n  json: true,\n  timeout: timeoutMs,\n};\n\nfunction extractJson(text) {\n  if (!text) return null;\n  const cleaned = text.replace(/```json|```/g, '').trim();\n  try {\n    return JSON.parse(cleaned);\n  } catch {\n    return null;\n  }\n}\n\nfunction heuristicClassification(message, stack) {\n  const text = `${message ?? ''} ${stack ?? ''}`.toLowerCase();\n  if (/(oomkilled|crashloopbackoff|liveness|readiness|probe|resource limit|memory|cpu|evicted|nodepressure)/.test(text)) {\n    return { classification: 'infrastructure', confidence: 'média', reasoning: 'Padrões típicos de infraestrutura detectados.' };\n  }\n  if (/(nullpointerexception|npe|indexoutofboundsexception|typeerror|attributeerror|syntax error|compilation)/.test(text)) {\n    return { classification: 'code', confidence: 'média', reasoning: 'Padrões típicos de erro de aplicação detectados.' };\n  }\n  if (/(timeout|timed out|connection refused|refused|connection reset|5\\d{2})/.test(text)) {\n    return { classification: 'unknown', confidence: 'média', reasoning: 'Indícios de falha externa ou timeout.' };\n  }\n  return { classification: 'unknown', confidence: 'baixa', reasoning: 'Sem padrões claros; requer investigação.' };\n}\n\nlet result;\ntry {\n  const response = await this.helpers.httpRequest(requestOptions);\n  const rawText = provider === 'gemini'\n    ? response?.candidates?.[0]?.content?.parts?.map((p) => p.text).join('')\n    : response?.choices?.[0]?.message?.content;\n\n  const parsed = extractJson(rawText);\n  if (parsed?.classification) {\n    result = {\n      classification: String(parsed.classification).toLowerCase(),\n      confidence: parsed.confidence ?? 'média',\n      reasoning: parsed.reasoning ?? ''\n    };\n  } else {\n    result = heuristicClassification(alert.error_message, alert.stack_trace);\n  }\n} catch (error) {\n  result = heuristicClassification(alert.error_message, alert.stack_trace);\n}\n\nconst normalized = ['infrastructure', 'code', 'unknown'].includes(result.classification)\n  ? result.classification\n  : 'unknown';\n\nconst confidence = ['alta', 'média', 'baixa'].includes(result.confidence)\n  ? result.confidence\n  : 'média';\n\nreturn [\n  {\n    json: {\n      ...alert,\n      classification: normalized,\n      confidence,\n      triage_reasoning: result.reasoning ?? '',\n      llm_provider: provider,\n      llm_model: model,\n    }\n  }\n];"
      },
      "id": "8",
      "name": "LLM - Triagem",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1080, 120]
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{$json.classification}}",
        "rules": [
          {
            "operation": "equals",
            "value2": "infrastructure"
          },
          {
            "operation": "equals",
            "value2": "code"
          },
          {
            "operation": "equals",
            "value2": "unknown"
          }
        ]
      },
      "id": "9",
      "name": "Classificacao?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 2,
      "position": [1300, 120]
    },
    {
      "parameters": {
        "keepOnlySet": false,
        "values": {
          "string": [
            {
              "name": "route",
              "value": "infrastructure"
            }
          ]
        }
      },
      "id": "10",
      "name": "Rota Infrastructure",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [1520, 40]
    },
    {
      "parameters": {
        "keepOnlySet": false,
        "values": {
          "string": [
            {
              "name": "route",
              "value": "code"
            }
          ]
        }
      },
      "id": "11",
      "name": "Rota Code",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [1520, 120]
    },
    {
      "parameters": {
        "keepOnlySet": false,
        "values": {
          "string": [
            {
              "name": "route",
              "value": "unknown"
            }
          ]
        }
      },
      "id": "12",
      "name": "Rota Unknown",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [1520, 200]
    },
    {
      "parameters": {
        "responseBody": "ok",
        "responseData": "text",
        "responseCode": 200
      },
      "id": "5",
      "name": "Responder 200",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1080, 240]
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "error",
              "value": "={{$json.errorMessage}}"
            }
          ]
        }
      },
      "id": "6",
      "name": "Montar Erro",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [860, 380]
    },
    {
      "parameters": {
        "responseBody": "={{$json.error}}",
        "responseData": "text",
        "responseCode": 400
      },
      "id": "7",
      "name": "Responder 400",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1080, 380]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Validar Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Payload": {
      "main": [
        [
          {
            "node": "Payload valido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Payload valido?": {
      "main": [
        [
          {
            "node": "Log Alert",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Montar Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Alert": {
      "main": [
        [
          {
            "node": "Responder 200",
            "type": "main",
            "index": 0
          },
          {
            "node": "LLM - Triagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM - Triagem": {
      "main": [
        [
          {
            "node": "Classificacao?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Classificacao?": {
      "main": [
        [
          {
            "node": "Rota Infrastructure",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Rota Code",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Rota Unknown",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Montar Erro": {
      "main": [
        [
          {
            "node": "Responder 400",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  }
}
