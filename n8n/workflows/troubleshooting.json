{
  "name": "Recepcao de Alertas - Auto Troubleshooting",
  "nodes": [
    {
      "parameters": {
        "path": "alert",
        "httpMethod": "POST",
        "responseMode": "responseNode"
      },
      "id": "1",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [200, 300],
      "webhookId": "b2e6f1d2-4f8c-4a1b-9b0f-6c7d7b1c2a10"
    },
    {
      "parameters": {
        "language": "javascript",
        "jsCode": "const required = ['service_name', 'namespace', 'pod_name', 'error_message'];\nconst item = $input.first().json;\nconst payload = item?.body ?? item;\nconst missing = required.filter((field) => !payload?.[field]);\n\nreturn [\n  {\n    json: {\n      ...payload,\n      isValid: missing.length === 0,\n      missing,\n      errorMessage: missing.length\n        ? `Campos obrigat√≥rios faltando: ${missing.join(', ')}`\n        : null,\n    },\n  },\n];"
      },
      "id": "2",
      "name": "Validar Payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [420, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.isValid}}",
              "value2": true
            }
          ]
        }
      },
      "id": "3",
      "name": "Payload valido?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [640, 300]
    },
    {
      "parameters": {
        "language": "javascript",
        "jsCode": "const alert = $json;\nconsole.log('[ALERT] Webhook recebido', JSON.stringify(alert));\nreturn $input.all();"
      },
      "id": "4",
      "name": "Log Alert",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [860, 240]
    },
    {
      "parameters": {
        "language": "javascript",
        "jsCode": "const alert = $json;\n\nconst systemPrompt = `# INSTRU√á√ïES DO ASSISTENTE DE DIAGN√ìSTICO\n\nVoc√™ √© um especialista em diagn√≥stico de incidentes de software. Sua tarefa √© analisar alertas de erro e fornecer diagn√≥sticos precisos e acion√°veis.\n\n## FLUXO DE AN√ÅLISE\n\n1. **TRIAGEM**: Classifique o erro em uma das categorias:\n   - \`infrastructure\`: Problemas de Kubernetes (OOMKilled, CrashLoopBackOff, probes, recursos)\n   - \`code\`: Bugs de aplica√ß√£o (exce√ß√µes, null pointers, erros de l√≥gica)\n   - \`unknown\`: Casos inconclusivos que precisam investiga√ß√£o adicional\n\n2. **INVESTIGA√á√ÉO**: Use as ferramentas dispon√≠veis para coletar evid√™ncias:\n   - Para \`infrastructure\`: use tools de Kubernetes (describePod, getEvents, etc.)\n   - Para \`code\`: use tools de Git (cloneRepo, readFile) para analisar o c√≥digo\n   - Para \`unknown\`: use httpRequest para testar conectividade se relevante\n\n3. **DIAGN√ìSTICO**: Produza um relat√≥rio com:\n   - Resumo executivo (2-3 frases)\n   - Classifica√ß√£o e confian√ßa\n   - Evid√™ncias coletadas\n   - Causa raiz identificada\n   - Sugest√µes de corre√ß√£o\n\n## INSTRU√á√ïES DE SEGURAN√áA (OBRIGAT√ìRIAS)\n\nNUNCA inclua no relat√≥rio:\n- Valores de vari√°veis de ambiente\n- Valores de Secrets do Kubernetes\n- Senhas, tokens, API keys ou credenciais\n- Dados pessoais (PII)\n\nAo mencionar Secrets ou ConfigMaps, liste APENAS os nomes das chaves, NUNCA os valores.\n\n‚úÖ CORRETO: \"O Secret \\\"db-credentials\\\" possui as chaves: username, password, host\"\n‚ùå INCORRETO: \"O Secret \\\"db-credentials\\\" cont√©m: username=admin, password=abc123\"\n\n## FORMATO DE RESPOSTA\n\nResponda sempre em JSON estruturado:\n\n{\n  \"classification\": \"infrastructure|code|unknown\",\n  \"confidence\": \"alta|m√©dia|baixa\",\n  \"reasoning\": \"Breve explica√ß√£o da classifica√ß√£o\"\n}\n`;\n\nconst triagePrompt = `Analise o seguinte alerta de erro e classifique-o:\n\n**Servi√ßo:** ${alert.service_name ?? ''}\n**Namespace:** ${alert.namespace ?? ''}\n**Pod:** ${alert.pod_name ?? ''}\n**Erro:** ${alert.error_message ?? ''}\n**Stack Trace:** ${alert.stack_trace ?? ''}\n\nResponda APENAS com JSON:\n{\n  \"classification\": \"infrastructure|code|unknown\",\n  \"confidence\": \"alta|m√©dia|baixa\",\n  \"reasoning\": \"Breve explica√ß√£o da classifica√ß√£o\"\n}`;\n\nconst provider = ($env.LLM_PROVIDER || 'openai').toLowerCase();\nconst model = $env.LLM_MODEL || 'gpt-5.2';\n\nconst timeoutSeconds = Number($env.LLM_TIMEOUT_SECONDS ?? 60);\nconst timeoutMs = Number.isFinite(timeoutSeconds) && timeoutSeconds > 0\n  ? timeoutSeconds * 1000\n  : 60000;\n\nconst openAiPayload = {\n  model,\n  messages: [\n    { role: 'system', content: systemPrompt },\n    { role: 'user', content: triagePrompt },\n  ],\n  temperature: 0.2,\n};\n\nconst geminiPayload = {\n  contents: [\n    { role: 'user', parts: [{ text: triagePrompt }] },\n  ],\n  systemInstruction: { parts: [{ text: systemPrompt }] },\n  generationConfig: { temperature: 0.2, responseMimeType: 'application/json' },\n};\n\nconst requestOptions = provider === 'gemini' ? {\n  method: 'POST',\n  url: 'https://generativelanguage.googleapis.com/v1/models/gemini-3.0-pro:generateContent',\n  headers: {\n    'content-type': 'application/json',\n    'x-goog-api-key': $env.LLM_API_KEY || '',\n  },\n  body: geminiPayload,\n  json: true,\n  timeout: timeoutMs,\n} : {\n  method: 'POST',\n  url: 'https://api.openai.com/v1/chat/completions',\n  headers: {\n    'content-type': 'application/json',\n    Authorization: `Bearer ${$env.LLM_API_KEY || ''}`\n  },\n  body: openAiPayload,\n  json: true,\n  timeout: timeoutMs,\n};\n\nfunction extractJson(text) {\n  if (!text) return null;\n  const cleaned = text.replace(/```json|```/g, '').trim();\n  try {\n    return JSON.parse(cleaned);\n  } catch {\n    return null;\n  }\n}\n\nfunction heuristicClassification(message, stack) {\n  const text = `${message ?? ''} ${stack ?? ''}`.toLowerCase();\n  if (/(oomkilled|crashloopbackoff|liveness|readiness|probe|resource limit|memory|cpu|evicted|nodepressure)/.test(text)) {\n    return { classification: 'infrastructure', confidence: 'm√©dia', reasoning: 'Padr√µes t√≠picos de infraestrutura detectados.' };\n  }\n  if (/(nullpointerexception|npe|indexoutofboundsexception|typeerror|attributeerror|syntax error|compilation)/.test(text)) {\n    return { classification: 'code', confidence: 'm√©dia', reasoning: 'Padr√µes t√≠picos de erro de aplica√ß√£o detectados.' };\n  }\n  if (/(timeout|timed out|connection refused|refused|connection reset|5\\d{2})/.test(text)) {\n    return { classification: 'unknown', confidence: 'm√©dia', reasoning: 'Ind√≠cios de falha externa ou timeout.' };\n  }\n  return { classification: 'unknown', confidence: 'baixa', reasoning: 'Sem padr√µes claros; requer investiga√ß√£o.' };\n}\n\nlet result;\ntry {\n  const response = await this.helpers.httpRequest(requestOptions);\n  const rawText = provider === 'gemini'\n    ? response?.candidates?.[0]?.content?.parts?.map((p) => p.text).join('')\n    : response?.choices?.[0]?.message?.content;\n\n  const parsed = extractJson(rawText);\n  if (parsed?.classification) {\n    result = {\n      classification: String(parsed.classification).toLowerCase(),\n      confidence: parsed.confidence ?? 'm√©dia',\n      reasoning: parsed.reasoning ?? ''\n    };\n  } else {\n    result = heuristicClassification(alert.error_message, alert.stack_trace);\n  }\n} catch (error) {\n  result = heuristicClassification(alert.error_message, alert.stack_trace);\n}\n\nconst normalized = ['infrastructure', 'code', 'unknown'].includes(result.classification)\n  ? result.classification\n  : 'unknown';\n\nconst confidence = ['alta', 'm√©dia', 'baixa'].includes(result.confidence)\n  ? result.confidence\n  : 'm√©dia';\n\nreturn [\n  {\n    json: {\n      ...alert,\n      classification: normalized,\n      confidence,\n      triage_reasoning: result.reasoning ?? '',\n      llm_provider: provider,\n      llm_model: model,\n    }\n  }\n];"
      },
      "id": "8",
      "name": "LLM - Triagem",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1080, 120]
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{$json.classification}}",
        "rules": [
          {
            "operation": "equals",
            "value2": "infrastructure"
          },
          {
            "operation": "equals",
            "value2": "code"
          },
          {
            "operation": "equals",
            "value2": "unknown"
          }
        ]
      },
      "id": "9",
      "name": "Classificacao?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 2,
      "position": [1300, 120]
    },
    {
      "parameters": {
        "keepOnlySet": false,
        "values": {
          "string": [
            {
              "name": "route",
              "value": "infrastructure"
            }
          ]
        }
      },
      "id": "10",
      "name": "Rota Infrastructure",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [1520, 40]
    },
    {
      "parameters": {
        "keepOnlySet": false,
        "values": {
          "string": [
            {
              "name": "route",
              "value": "code"
            }
          ]
        }
      },
      "id": "11",
      "name": "Rota Code",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [1520, 120]
    },
    {
      "parameters": {
        "keepOnlySet": false,
        "values": {
          "string": [
            {
              "name": "route",
              "value": "unknown"
            }
          ]
        }
      },
      "id": "12",
      "name": "Rota Unknown",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [1520, 200]
    },
    {
      "parameters": {
        "language": "javascript",
        "jsCode": "const { randomUUID } = require('crypto');\nconst Handlebars = require('handlebars');\n\nHandlebars.registerHelper('inc', (index) => Number(index) + 1);\n\nconst template = [\n  '# üîç Diagn√≥stico de Incidente',\n  '',\n  '**Ticket ID:** `{{ticket_id}}`  ',\n  '**Data:** {{timestamp}}  ',\n  '**Servi√ßo:** {{service_name}}  ',\n  '**Namespace:** {{namespace}}  ',\n  '',\n  '---',\n  '',\n  '## üìã Resumo Executivo',\n  '',\n  '{{summary}}',\n  '',\n  '## üè∑Ô∏è Classifica√ß√£o',\n  '',\n  '| Campo | Valor |',\n  '|-------|-------|',\n  '| **Tipo** | {{classification}} |',\n  '| **Severidade** | {{severity}} |',\n  '| **Confian√ßa** | {{confidence}} |',\n  '',\n  '---',\n  '',\n  '## üîé Evid√™ncias Coletadas',\n  '',\n  '### Erro Original',\n  '',\n  '```',\n  '{{error_message}}',\n  '```',\n  '',\n  '{{#if stack_trace}}',\n  '### Stack Trace',\n  '',\n  '```',\n  '{{stack_trace}}',\n  '```',\n  '{{/if}}',\n  '',\n  '{{#if kubernetes_evidence}}',\n  '### An√°lise de Kubernetes',\n  '',\n  '{{kubernetes_evidence}}',\n  '{{/if}}',\n  '',\n  '{{#if code_evidence}}',\n  '### An√°lise de C√≥digo',\n  '',\n  '{{code_evidence}}',\n  '{{/if}}',\n  '',\n  '{{#if network_evidence}}',\n  '### Teste de Conectividade',\n  '',\n  '{{network_evidence}}',\n  '{{/if}}',\n  '',\n  '---',\n  '',\n  '## üéØ Causa Raiz Identificada',\n  '',\n  '{{root_cause}}',\n  '',\n  '---',\n  '',\n  '## üí° Sugest√µes de Corre√ß√£o',\n  '',\n  '{{#each suggestions}}',\n  '{{inc @index}}. {{this}}',\n  '{{/each}}',\n  '',\n  '---',\n  '',\n  '## ‚è≠Ô∏è Pr√≥ximos Passos',\n  '',\n  '{{#each next_steps}}',\n  '- [ ] {{this}}',\n  '{{/each}}',\n  '',\n  '---',\n  '',\n  '*Este diagn√≥stico foi gerado automaticamente pelo Auto-Troubleshooting Inteligente.*',\n  '',\n  '*Para an√°lise adicional, voc√™ pode usar GitHub Copilot ou Claude Code com este relat√≥rio.*',\n  '',\n  'üìß [Dar feedback sobre este diagn√≥stico]({{feedback_url}})',\n].join('\\n');\n\nconst SECRET_PATTERN = /(password|pass|pwd|secret|token|api[_-]?key|authorization|private[_-]?key|client_secret|access[_-]?token|refresh[_-]?token)\\s*[:=]\\s*[^\\s,;]+/gi;\n\nfunction sanitizeText(text) {\n  if (!text) return '';\n  return String(text).replace(SECRET_PATTERN, (match) => {\n    const key = match.split(/[:=]/)[0];\n    return `${key}: [REDACTED]`;\n  });\n}\n\nfunction sanitizeArray(value) {\n  if (!Array.isArray(value)) return [];\n  return value.map((entry) => sanitizeText(entry)).filter(Boolean);\n}\n\nfunction formatKubernetesEvidence(podDescription, events) {\n  if (!podDescription && !events) return '';\n\n  let output = '';\n  if (podDescription?.name) {\n    output += `**Pod:** ${sanitizeText(podDescription.name)}\\n`;\n  }\n  if (podDescription?.status) {\n    output += `**Status:** ${sanitizeText(podDescription.status)}\\n\\n`;\n  }\n\n  if (podDescription?.containerStatuses?.length) {\n    output += '**Containers:**\\n';\n    for (const container of podDescription.containerStatuses) {\n      const readyLabel = container.ready ? '‚úÖ Ready' : '‚ùå Not Ready';\n      output += `- ${sanitizeText(container.name)}: ${readyLabel}`;\n      if (Number.isFinite(container.restartCount)) {\n        output += ` (Restarts: ${container.restartCount})`;\n      }\n      output += '\\n';\n\n      if (container.state?.terminated) {\n        output += `  - Terminated: ${sanitizeText(container.state.terminated.reason)}\\n`;\n      }\n      if (container.state?.waiting) {\n        output += `  - Waiting: ${sanitizeText(container.state.waiting.reason)}\\n`;\n      }\n    }\n  }\n\n  if (events?.length) {\n    output += '\\n**Eventos Recentes:**\\n';\n    for (const event of events.slice(-5)) {\n      const icon = event.type === 'Warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';\n      output += `${icon} [${sanitizeText(event.reason)}] ${sanitizeText(event.message)}\\n`;\n    }\n  }\n\n  return output.trim();\n}\n\nfunction formatCodeEvidence(filePath, lineNumber, codeSnippet, language = '') {\n  if (!codeSnippet) return '';\n\n  const lines = String(codeSnippet).split('\\n');\n  const safeLineNumber = Number(lineNumber) || 1;\n  const startLine = Math.max(1, safeLineNumber - 5);\n\n  let output = `**Arquivo:** \\`${sanitizeText(filePath || 'arquivo desconhecido')}\\`\\n`;\n  output += `**Linha:** ${safeLineNumber}\\n\\n`;\n  output += `\\`\\`\\`${sanitizeText(language)}\\n`;\n\n  lines.forEach((line, index) => {\n    const currentLine = startLine + index;\n    const marker = currentLine === safeLineNumber ? '>>>' : '   ';\n    output += `${marker} ${currentLine}: ${sanitizeText(line)}\\n`;\n  });\n\n  output += '\\`\\`\\`\\n';\n\n  return output.trim();\n}\n\nfunction formatNetworkEvidence(networkInfo) {\n  if (!networkInfo) return '';\n  if (typeof networkInfo === 'string') return sanitizeText(networkInfo);\n\n  const url = networkInfo.url ? `**URL:** ${sanitizeText(networkInfo.url)}\\n` : '';\n  const status = networkInfo.status_code ? `**Status:** ${sanitizeText(networkInfo.status_code)}\\n` : '';\n  const responseTime = networkInfo.response_time_ms\n    ? `**Tempo de resposta:** ${sanitizeText(networkInfo.response_time_ms)}ms\\n`\n    : '';\n  const error = networkInfo.error ? `**Erro:** ${sanitizeText(networkInfo.error)}\\n` : '';\n\n  return `${url}${status}${responseTime}${error}`.trim();\n}\n\nfunction normalize(value, allowed, fallback) {\n  const normalized = String(value || fallback).toLowerCase();\n  return allowed.includes(normalized) ? normalized : fallback;\n}\n\nconst input = $json;\nconst ticketId = input.ticket_id || input.ticketId || randomUUID();\nconst timestamp = input.timestamp || new Date().toISOString();\n\nconst podDescription = input.pod_description\n  || input.kubernetes_pod_description\n  || input.kubernetes?.podDescription\n  || input.kubernetes?.pod\n  || null;\n\nconst events = input.events\n  || input.kubernetes_events\n  || input.kubernetes?.events\n  || null;\n\nconst kubernetesEvidence = input.kubernetes_evidence\n  || formatKubernetesEvidence(podDescription, events);\n\nconst codeEvidenceDetail = input.code_evidence_detail\n  || input.code\n  || null;\n\nconst codeEvidence = typeof input.code_evidence === 'string'\n  ? input.code_evidence\n  : (codeEvidenceDetail\n    ? formatCodeEvidence(\n      codeEvidenceDetail.filePath || codeEvidenceDetail.file_path,\n      codeEvidenceDetail.lineNumber || codeEvidenceDetail.line_number,\n      codeEvidenceDetail.codeSnippet || codeEvidenceDetail.code_snippet,\n      codeEvidenceDetail.language || codeEvidenceDetail.lang || ''\n    )\n    : '');\n\nconst networkEvidence = input.network_evidence\n  || formatNetworkEvidence(input.network || null);\n\nconst suggestions = sanitizeArray(input.suggestions);\nconst nextSteps = sanitizeArray(input.next_steps || input.nextSteps);\n\nconst reportData = {\n  ticket_id: ticketId,\n  timestamp,\n  service_name: sanitizeText(input.service_name || 'servi√ßo n√£o informado'),\n  namespace: sanitizeText(input.namespace || 'namespace n√£o informado'),\n  summary: sanitizeText(input.summary) || 'Resumo n√£o fornecido; revisar evid√™ncias coletadas.',\n  classification: normalize(input.classification, ['infrastructure', 'code', 'unknown'], 'unknown'),\n  severity: normalize(input.severity, ['critical', 'high', 'medium', 'low'], 'medium'),\n  confidence: normalize(input.confidence, ['alta', 'm√©dia', 'baixa'], 'm√©dia'),\n  error_message: sanitizeText(input.error_message || 'Erro n√£o informado'),\n  stack_trace: sanitizeText(input.stack_trace || ''),\n  kubernetes_evidence: sanitizeText(kubernetesEvidence),\n  code_evidence: sanitizeText(codeEvidence),\n  network_evidence: sanitizeText(networkEvidence),\n  root_cause: sanitizeText(input.root_cause) || 'Causa raiz n√£o identificada automaticamente.',\n  suggestions: suggestions.length\n    ? suggestions\n    : ['Revisar logs completos e m√©tricas do servi√ßo', 'Validar configura√ß√µes e limites de recursos'],\n  next_steps: nextSteps.length\n    ? nextSteps\n    : ['Confirmar corre√ß√£o em ambiente de homologa√ß√£o', 'Monitorar o servi√ßo ap√≥s o ajuste'],\n  feedback_url: sanitizeText(input.feedback_url || input.feedbackUrl || input.feedback)\n    || `https://feedback.local/diagnosis/${ticketId}`,\n};\n\nconst compiled = Handlebars.compile(template, { noEscape: true });\nconst report = compiled(reportData);\n\nreturn [\n  {\n    json: {\n      ...input,\n      ticket_id: ticketId,\n      timestamp,\n      diagnosis_report: report,\n      report_markdown: report,\n      report_data: reportData,\n    },\n  },\n];"
      },
      "id": "13",
      "name": "Gerar Relatorio",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1740, 120]
    },
    {
      "parameters": {
        "responseBody": "ok",
        "responseData": "text",
        "responseCode": 200
      },
      "id": "5",
      "name": "Responder 200",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1080, 240]
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "error",
              "value": "={{$json.errorMessage}}"
            }
          ]
        }
      },
      "id": "6",
      "name": "Montar Erro",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [860, 380]
    },
    {
      "parameters": {
        "responseBody": "={{$json.error}}",
        "responseData": "text",
        "responseCode": 400
      },
      "id": "7",
      "name": "Responder 400",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1080, 380]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Validar Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Payload": {
      "main": [
        [
          {
            "node": "Payload valido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Payload valido?": {
      "main": [
        [
          {
            "node": "Log Alert",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Montar Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Alert": {
      "main": [
        [
          {
            "node": "Responder 200",
            "type": "main",
            "index": 0
          },
          {
            "node": "LLM - Triagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM - Triagem": {
      "main": [
        [
          {
            "node": "Classificacao?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Classificacao?": {
      "main": [
        [
          {
            "node": "Rota Infrastructure",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Rota Code",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Rota Unknown",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rota Infrastructure": {
      "main": [
        [
          {
            "node": "Gerar Relatorio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rota Code": {
      "main": [
        [
          {
            "node": "Gerar Relatorio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rota Unknown": {
      "main": [
        [
          {
            "node": "Gerar Relatorio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Montar Erro": {
      "main": [
        [
          {
            "node": "Responder 400",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  }
}
